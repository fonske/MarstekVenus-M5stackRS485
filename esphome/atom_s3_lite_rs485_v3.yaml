substitutions:
  name: marstek_m1    ## change name to marstek_m2 or marstek_m3 for more batterys
  friendly_name: MT1  ## change name to MT2 or MT3 for more batterys

## Version 1.11 - M5stack Marstek V3  (see rule numer 20)
#
# not working:
# sensor:
#   ac_offgrid_power
#   software_version
#   firmware_version
#   ac_current
#   ac_offgrid_current
# number:
#   charging_cutoff_capacity
#   discharging_cutoff_capacity

esphome:
  name: ${name}
  # friendly_name: ${friendly_name}  ### temporarely uncommented because of sensor naming wrong for nodered flow gitcode bob
  min_version: 2025.11.0
  name_add_mac_suffix: false

esp32:
  board: esp32-s3-devkitc-1  ## M5stack Atom S3 lite  
  flash_size: 8MB
  variant: esp32s3
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    version: recommended
    ## Custom sdkconfig options
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_BT_ENABLED: n

psram:
  mode: octal
  speed: 80MHz

## Enable/Disable logging
logger:
  logs:
    component: ERROR
  
## Enable Home Assistant API
api:
  reboot_timeout: 0s
#  encryption:
#    key: !secret marstek_m1_api_encryption_key

## Enable OTA updates
ota:
  - platform: esphome
  - platform: web_server
#  password: !secret marstek_m1_ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  reboot_timeout: 0s
  fast_connect: true
  power_save_mode: high
  use_psram: true

## uncomment if you need a fixed ip address
#  manual_ip:
#    static_ip: 192.168.178.126
#    gateway: 192.168.178.1
#    subnet: 255.255.255.0

## Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${friendly_name} Hotspot"
    password: "configesp"
    ap_timeout: 15s

captive_portal:
  id: id_captive_portal
  
web_server:
  port: 80
  version: 3
  include_internal: False
#  ota: False
  local: True
  sorting_groups:
    - id: Info
      name: "Info"
      sorting_weight: -40
    - id: Control
      name: "Control"
      sorting_weight: -30
    - id: Status
      name: "Status"
      sorting_weight: -20
    - id: Diagnostic
      name: "Diagnostic"
      sorting_weight: -10

## Configure i2c (grove port on Atom S3)
i2c:
  - id: bus_a
    sda: GPIO2
    scl: GPIO1

## Configure UART
uart:
  - id: mod_bus
    tx_pin: GPIO6
    rx_pin: GPIO5
    baud_rate: 115200
    data_bits: 8
    stop_bits: 1
    parity: NONE

modbus:
  - uart_id: mod_bus
    id: modbus1
    send_wait_time: 20ms

modbus_controller:
  - id: mt
    address: 0x1
    modbus_id: modbus1
    command_throttle: 20ms
    update_interval: 2s

##G4=IR
#remote_transmitter:
#  pin: GPIO4
#  carrier_duty_percent: 50%

# Uart logging on/off switch
switch:
  - platform: template
    name: UART Logging
    id: uart_debug_switch
    icon: mdi:text
    restore_mode: ALWAYS_OFF
    optimistic: true
    turn_on_action:
      - logger.set_level: VERBOSE
    turn_off_action:
      - logger.set_level: ERROR
    entity_category: diagnostic
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 20
      
# Tekstsensoren
text_sensor:
  - name: "Device Name"
    id: device_name
    icon: mdi:rename-outline
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 31000
    register_count: 10
    response_size: 20
    skip_updates: 60 # 5 minutes
    entity_category: diagnostic
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 7

#  - name: "Software Version"   # missing on V3 / V139 ?
#    id: software_version_text
#    icon: mdi:factory
#    platform: template
#    update_interval: never  # updates only when sensor triggers
#    entity_category: diagnostic
#    web_server:
#      sorting_group_id: Diagnostic
#      sorting_weight: 8

#  - name: "Firmware Version"   # missing on V3 / V139 ?
#    id: firmware_version_text
#    icon: mdi:factory
#    platform: template
#    update_interval: never  # updates only when sensor triggers
#    entity_category: diagnostic
#    web_server:
#      sorting_group_id: Diagnostic
#      sorting_weight: 9

  - name: "VNS Version"
    id: vns_version_text
    icon: mdi:factory
    platform: template
    update_interval: never  # updates only when sensor triggers
    entity_category: diagnostic
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 10

  - name: "EMS Version"
    id: ems_version_text
    icon: mdi:factory
    platform: template
    update_interval: never  # updates only when sensor triggers
    entity_category: diagnostic
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 11

  - name: "BMS Version"
    id: bms_version_text
    icon: mdi:factory
    platform: template
    update_interval: never  # updates only when sensor triggers
    entity_category: diagnostic
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 12

  - name: "Inverter State"
    id: inverter_state_text
    icon: mdi:state-machine
    platform: template
    lambda: |-
      switch (int(id(inverter_state).state)) {
        case 0: return std::string("Sleep");
        case 1: return std::string("Standby");
        case 2: return std::string("Charge");
        case 3: return std::string("Discharge");
        case 4: return std::string("Fault");
        case 5: return std::string("Idle");
        case 6: return std::string("AC bypass");
        default: return std::string("Unknown");
      };
    update_interval: 5s
    web_server:
      sorting_group_id: Info
      sorting_weight: 5

  - platform: wifi_info
    ip_address:
      name: ESP IP
      icon: mdi:ip
      web_server:
        sorting_group_id: Diagnostic
        sorting_weight: 4
    ssid:
      name: ESP SSID
      icon: mdi:wifi
      web_server:
        sorting_group_id: Diagnostic
        sorting_weight: 3

  - platform: version
    name: ESP Version
    hide_timestamp: true
    disabled_by_default: false
    icon: mdi:new-box
    entity_category: diagnostic
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 2

  - name: "Wifi status"
    id: wifi_status
    icon: mdi:wifi-alert
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30300
    raw_encode: NONE
    entity_category: diagnostic
    skip_updates: 20
    lambda: |-
      uint16_t int_mode = (data[item->offset] << 8) + data[item->offset+1];
      ESP_LOGD("main","Parsed operation mode int : %d", int_mode);
      std::string mode_str;
      switch (int_mode) {
        case 0:  mode_str = "Disconnected"; break;
        case 1:  mode_str = "Connected"; break;                                                              
      }
      return mode_str;
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 20

  - name: "BT status"
    id: bt_status
    icon: mdi:home-heart
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30301
    raw_encode: NONE
    entity_category: diagnostic
    skip_updates: 20
    lambda: |-
      uint16_t int_mode = (data[item->offset] << 8) + data[item->offset+1];
      ESP_LOGD("main","Parsed operation mode int : %d", int_mode);
      std::string mode_str;
      switch (int_mode) {
        case 0:  mode_str = "Off"; break;
        case 1:  mode_str = "Active after boot"; break;    
        case 2:  mode_str = "Connected"; break; 
        case 3:  mode_str = "Active"; break;                                                           
        case 4:  mode_str = "Disabled"; break;
      }
      return mode_str;
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 21

  - name: "Cloud status"
    id: cloud_status
    icon: mdi:home-heart
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30302
    raw_encode: NONE
    entity_category: diagnostic
    skip_updates: 20
    lambda: |-
      uint16_t int_mode = (data[item->offset] << 8) + data[item->offset+1];
      ESP_LOGD("main","Parsed operation mode int : %d", int_mode);
      std::string mode_str;
      switch (int_mode) {
        case 0:  mode_str = "Disconnected"; break;
        case 1:  mode_str = "Connected"; break;                                                              
      }
      return mode_str;
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 22

# Binaire sensoren
binary_sensor:
## Push button on top of Atom S3 lite
## Short push = led On or Off
## Long push = led brightness changes
  - platform: gpio
    pin:
      number: GPIO41
      inverted: true
      mode: INPUT_PULLUP
    name: "Brightness Button"
    id: brightness_button
    internal: true
    icon: mdi:brightness-6
    on_multi_click:
      - timing:
          - ON for at least 1s
        then:
          - logger.log: "Lange druk gedetecteerd - start helderheid aanpassen"
          - script.execute: adjust_brightness_loop

      - timing:
          - ON for at most 700ms
          - OFF for at least 50ms
        then:
          - logger.log: "Korte druk - toggle LED"
          - light.toggle: status_led

    on_release:
      then:
        - script.stop: adjust_brightness_loop
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 15

## Sensoren
sensor:
  - name: "Atom temperature"
    id: atom_temperature
    icon: mdi:thermometer
    platform: internal_temperature
    update_interval: 30s
    entity_category: diagnostic
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 14

  - name: "Battery Wifi Signal Strength"
    id: battery_wifi_signal_strength
    icon: mdi:wifi
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30303
    value_type: U_WORD
    unit_of_measurement: "dBm"
    filters:
      - multiply: -1
    accuracy_decimals: 0   
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 7

  - name: Battery Wifi signal
    id: battery_wifi_signal_proc
    icon: mdi:wifi
    platform: copy # Reports the Battery signal strength in %
    source_id: battery_wifi_signal_strength
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: "%"
    entity_category: diagnostic
    device_class: ""
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 6

  - id: inverter_state  # No name, since it's internal
    icon: mdi:state-machine
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35100
    value_type: U_WORD
    internal: true # Hides from Home Assistant
    web_server:
      sorting_group_id: Info
      sorting_weight: 30

#  - id: software_version # No name, since it's internal / on V3 working?
#    icon: mdi:factory
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 31100
#    value_type: U_WORD
#    accuracy_decimals: 0
#    skip_updates: 60 # 5 minutes
#    internal: true # Hides from Home Assistant
#    on_value:
#      then:
#        - lambda: |-
#            int version = (int)x;
#            char buf[5];
#            sprintf(buf, "V%d", version);
#            id(software_version_text).publish_state(buf);

 # - id: firmware_version # No name, since it's internal / on V3 working?
 #   icon: mdi:factory
 #   platform: modbus_controller
 #   modbus_controller_id: mt
 #   register_type: holding
 #   address: 31101
 #   value_type: U_WORD
 #   accuracy_decimals: 0
 #   skip_updates: 60 # 5 minutes
 #   internal: true # Hides from Home Assistant
 #   on_value:
 #     then:
 #       - lambda: |-
 #           int version = (int)x;
 #           char buf[5];
 #           sprintf(buf, "V%d", version);
 #           id(firmware_version_text).publish_state(buf);

  - id: ems_version # No name, since it's internal
    icon: mdi:factory
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30200
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: 60 # 5 minutes
    internal: true
    on_value:
      then:
        - lambda: |-
            int version = (int)x;
            char buf[5];
            sprintf(buf, "V%d", version);
            id(ems_version_text).publish_state(buf);

  - id: vns_version # No name, since it's internal
    icon: mdi:factory
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30202
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: 60 # 5 minutes
    internal: true
    on_value:
      then:
        - lambda: |-
            int version = (int)x;
            char buf[5];
            sprintf(buf, "V%d", version);
            id(vns_version_text).publish_state(buf);

  - id: bms_version # No name, since it's internal
    icon: mdi:factory
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30204 #31102
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: 60 # 5 minutes
    internal: true
    on_value:
      then:
        - lambda: |-
            int version = (int)x;
            char buf[5];
            sprintf(buf, "V%d", version);
            id(bms_version_text).publish_state(buf);

  - name: "Battery Voltage"
    id: battery_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30100 #32100 in V12
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 2
    state_class: measurement
    filters:
      - multiply: 0.01
    skip_updates: 60 # 5 minutes
    web_server:
      sorting_group_id: Info
      sorting_weight: 16

  - name: "Battery Current"
    icon: mdi:current-dc
    id: battery_current
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30101 #32101 in V12
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    accuracy_decimals: 2
    state_class: measurement
    filters:
      - multiply: 0.1
    skip_updates: 60 # 10 seconds
    web_server:
      sorting_group_id: Info
      sorting_weight: 15
    
  - name: "Battery Power"
    id: battery_power
    icon: mdi:flash
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 30001
    value_type: S_WORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: 0
    web_server:
      sorting_group_id: Info
      sorting_weight: 14

  - name: "Battery State Of Charge"
    id: battery_state_of_charge
    icon: mdi:power-plug-battery-outline
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32104
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0
    web_server:
      sorting_group_id: Info
      sorting_weight: 6

  - name: "Battery Total Energy"
    id: battery_total_energy
    icon: mdi:battery-charging-100
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32105 
    value_type: U_WORD
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    filters:
      - multiply: 0.001 
    skip_updates: 60 # 5 minutes
    web_server:
      sorting_group_id: Info
      sorting_weight: 8

  - name: "Battery Remaining Capacity"
    id: battery_remaining_capacity
    icon: mdi:battery-arrow-down-outline
    platform: template
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    update_interval: 300s
    lambda: |-
      if (id(battery_total_energy).has_state() && id(battery_state_of_charge).has_state()) {
        float total_energy = id(battery_total_energy).state;
        float soc = id(battery_state_of_charge).state / 100.0;
        return roundf(total_energy * soc * 100) / 100; // Ensures two decimal places
      }
      return NAN;
    web_server:
      sorting_group_id: Info
      sorting_weight: 7

  - name: "AC Power"
    id: ac_power
    icon: mdi:flash
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32202
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: 1 # 10 seconds
    web_server:
      sorting_group_id: Info
      sorting_weight: 1

#  - name: "AC Current"    # missing on V3 / V139 ?
#    id: ac_current
#    icon: mdi:current-ac
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 32201 #37004 V3?
#    value_type: U_WORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01 #0.004 V3?
#    skip_updates: 2 # 10 seconds
#    web_server:
#      sorting_group_id: Info
#      sorting_weight: 2

  - name: "AC Voltage"
    id: ac_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32200
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 2 # 10 seconds 
    web_server:
      sorting_group_id: Info
      sorting_weight: 3

  - name: "AC Frequency"
    id: ac_frequency
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32204
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 2 # 10 seconds 
    web_server:
      sorting_group_id: Info
      sorting_weight: 4

#  - name: "AC Offgrid Voltage"  # 32300 gives 0x7E2C modbus error on v3/ if backup outlet not switched on?
#    id: ac_offgrid_voltage
#    icon: mdi:sine-wave
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 32300
#    value_type: U_WORD
#    unit_of_measurement: "V"
#    device_class: voltage
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1
#    web_server:
#      sorting_group_id: Info
#      sorting_weight: 44

#  - name: "AC Offgrid Current"
#    id: ac_offgrid_current
#    icon: mdi:current-ac
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 32301
#    value_type: U_WORD
#    unit_of_measurement: "A"
#    device_class: current
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01
#    web_server:
#      sorting_group_id: Info
#      sorting_weight: 45

#  - name: "AC Offgrid Power"
#    id: ac_offgrid_power
#    icon: mdi:flash
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 32302
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 0
#    web_server:
#      sorting_group_id: Info
#      sorting_weight: 43

  - name: "Maximum Cell Voltage"
    id: max_cell_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 37007
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 24

  - name: "Minimum Cell Voltage"
    id: min_cell_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 37008
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 25

  - name: "Cell Voltage Delta"
    id: cell_voltage_delta
    icon: mdi:sine-wave
    platform: template
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    lambda: |-
      if (isnan(id(max_cell_voltage).state) || isnan(id(min_cell_voltage).state)) {
        return NAN;
      }
      return id(max_cell_voltage).state - id(min_cell_voltage).state;
    web_server:
      sorting_group_id: Info
      sorting_weight: 26

  - name: "Cell 1 Voltage"  #V3 only
    id: cell_1_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34018
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 27

  - name: "Cell 2 Voltage"  #V3 only
    id: cell_2_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34019
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 28

  - name: "Cell 3 Voltage"  #V3 only
    id: cell_3_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34020
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 29

  - name: "Cell 4 Voltage"  #V3 only
    id: cell_4_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34021
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 30

  - name: "Cell 5 Voltage"  #V3 only
    id: cell_5_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34022
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 31

  - name: "Cell 6 Voltage"  #V3 only
    id: cell_6_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34023
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 32

  - name: "Cell 7 Voltage"  #V3 only
    id: cell_7_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34024
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 33

  - name: "Cell 8 Voltage"  #V3 only
    id: cell_8_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34025
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 34

  - name: "Cell 9 Voltage"  #V3 only
    id: cell_9_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34026
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 35

  - name: "Cell 10 Voltage"  #V3 only
    id: cell_10_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34027
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 36

  - name: "Cell 11 Voltage"  #V3 only
    id: cell_11_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34028
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 37

  - name: "Cell 12 Voltage"  #V3 only
    id: cell_12_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34029
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 38

  - name: "Cell 13 Voltage"  #V3 only
    id: cell_13_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34030
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 39

  - name: "Cell 14 Voltage"  #V3 only
    id: cell_14_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34031
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 40

  - name: "Cell 15 Voltage"  #V3 only
    id: cell_15_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34032
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 41


  - name: "Cell 16 Voltage"  #V3 only
    id: cell_16_voltage
    icon: mdi:sine-wave
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 34033
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 3
    state_class: measurement
    filters:
      - multiply: 0.001
    skip_updates: 10
    web_server:
      sorting_group_id: Info
      sorting_weight: 42

  - name: "Lifetime Charging Energy"
    id: lifetime_charging_energy
    icon: mdi:chart-bar
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33000
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    web_server:
      sorting_group_id: Info
      sorting_weight: 12

  - name: "Lifetime Discharging Energy"
    id: lifetime_discharging_energy
    icon: mdi:chart-bar
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33002
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    web_server:
      sorting_group_id: Info
      sorting_weight: 13

  - name: "Lifetime Round Trip Efficiency"
    id: lifetime_round_trip_efficiency
    icon: mdi:percent
    platform: template
    unit_of_measurement: "%"
    accuracy_decimals: 1
    state_class: measurement
    lambda: |-
      if (!id(lifetime_charging_energy).has_state() ||
          !id(lifetime_discharging_energy).has_state()) {
        return NAN;
      }
      float total_charge = id(lifetime_charging_energy).state;       // kWh in
      float total_discharge = id(lifetime_discharging_energy).state; // kWh out
      if (total_charge <= 0.0f) {
        return NAN;  // avoid divide-by-zero until we have data
      }
      float eff = (total_discharge / total_charge) * 100.0f;
      // Optional: clamp to a sane range to avoid noise
      if (eff < 0.0f) eff = 0.0f;
      if (eff > 110.0f) eff = 110.0f;
      return eff;
    web_server:
      sorting_group_id: Info
      sorting_weight: 14

  - name: "Daily Charging Energy"
    id: daily_charging_energy
    icon: mdi:chart-bar
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33004
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    web_server:
      sorting_group_id: Info
      sorting_weight: 9

  - name: "Daily Discharging Energy"
    id: daily_discharging_energy
    icon: mdi:chart-bar
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33006
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    web_server:
      sorting_group_id: Info
      sorting_weight: 10

# Slow Sensor
  - name: "Monthly Charging Energy"   
    id: monthly_charging_energy
    icon: mdi:chart-bar
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33008
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes
    web_server:
      sorting_group_id: Info
      sorting_weight: 11

# Slow Sensor
  - name: "Monthly Discharging Energy"
    id: monthly_discharging_energy
    icon: mdi:chart-bar
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33010
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes
    web_server:
      sorting_group_id: Info
      sorting_weight: 12

  - name: "Internal Temperature"
    id: internal_mt_temperature
    icon: mdi:thermometer
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35000
    value_type: S_WORD
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 60 # 5 minutes
    web_server:
      sorting_group_id: Info
      sorting_weight: 19

  - name: "Internal MOS1 Temperature"
    id: internal_mos1_temperature
    icon: mdi:thermometer
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35001
    value_type: S_WORD
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 60 # 5 minutes
    web_server:
      sorting_group_id: Info
      sorting_weight: 20

  - name: "Internal MOS2 Temperature"
    id: internal_mos2_temperature
    icon: mdi:thermometer
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35002
    value_type: S_WORD
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.1
    web_server:
      sorting_group_id: Info
      sorting_weight: 21

  - name: "Max Cell Temperature"
    id: max_cell_temperature
    icon: mdi:thermometer
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35010
    value_type: S_WORD
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.1
    web_server:
      sorting_group_id: Info
      sorting_weight: 22
    
  - name: "Min Cell Temperature"
    id: min_cell_temperature
    icon: mdi:thermometer
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35011
    value_type: S_WORD
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    web_server:
      sorting_group_id: Info
      sorting_weight: 23

  - name: "Battery Charge Voltage Limit"
    id: battery_charge_voltage_limit
    platform: modbus_controller
    icon: mdi:sine-wave
    modbus_controller_id: mt
    register_type: holding
    address: 35110
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.01
    web_server:
      sorting_group_id: Info
      sorting_weight: 16

# Slow Sensor 
  - name: "Battery Charge Current Limit"
    id: battery_charge_current_limit
    icon: mdi:current-dc
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35111
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.01
    web_server:
      sorting_group_id: Info
      sorting_weight: 17

# Slow Sensor 
  - name: "Battery Discharge Current Limit"
    id: battery_discharge_current_limit
    icon: mdi:current-dc
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35112
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.01
    web_server:
      sorting_group_id: Info
      sorting_weight: 18

  # An internal sensor to check Modbus communication status.
  - name: "Modbus Status"
    id: modbus_status
    icon: mdi:transit-connection
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32104  # Using the Battery SOC register as a reference
    value_type: U_WORD
    internal: true # Hides from Home Assistant
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 15

# Instellingen en modi (Select en Number)
select:
  - name: "RS485 Control Mode"
    id: rs485_control_mode
    icon: mdi:connection
    platform: modbus_controller
    modbus_controller_id: mt
    address: 42000
    value_type: U_WORD
    optionsmap:
      "enable": 21930
      "disable": 21947
    skip_updates: 2 # 10 seconds
    web_server:
      sorting_group_id: Control
      sorting_weight: 1

  - name: "User Work Mode"
    id: user_work_mode
    icon: mdi:auto-mode
    platform: modbus_controller
    modbus_controller_id: mt
    address: 43000
    value_type: U_WORD
    optionsmap:
      "manual": 0
      "anti-feed": 1
      "ai": 2
    skip_updates: 2 # 10 seconds
    web_server:
      sorting_group_id: Control
      sorting_weight: 2

  - name: "Backup Function"
    id: backup_function
    icon: mdi:power-plug-battery
    platform: modbus_controller
    modbus_controller_id: mt
    address: 41200
    value_type: U_WORD
    optionsmap:
      "enable": 0
      "disable": 1
    skip_updates: 2 # 10 seconds
    web_server:
      sorting_group_id: Control
      sorting_weight: 3 

  - name: "Forcible Charge/Discharge"
    id: forcible_charge_discharge
    icon: mdi:arrow-up-down
    platform: modbus_controller
    modbus_controller_id: mt
    address: 42010
    value_type: U_WORD
    optionsmap:
      "stop": 0
      "charge": 1
      "discharge": 2
    web_server:
      sorting_group_id: Control
      sorting_weight: 4

number:
  - name: "Charge To SOC"
    id: charge_to_soc
    icon: mdi:battery-charging-medium 
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 42011
    value_type: U_WORD
    unit_of_measurement: "%"
    min_value: 12
    max_value: 100
    step: 1
    web_server:
      sorting_group_id: Control
      sorting_weight: 9

  - name: "Forcible Charge Power"
    id: forcible_charge_power
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 42020
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds
    web_server:
      sorting_group_id: Control
      sorting_weight: 5

  - name: "Forcible Discharge Power"
    id: forcible_discharge_power
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 42021
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds
    web_server:
      sorting_group_id: Control
      sorting_weight: 6

#  - name: "Charging Cutoff Capacity" # not working on V3 / V139 ?
#    id: charging_cutoff_capacity
#    icon: mdi:battery-90
#    mode: box
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 44000
#    value_type: U_WORD
#    unit_of_measurement: "%"
#    min_value: 80
#    max_value: 100
#    multiply: 10
#    skip_updates: 6 # 30 seconds
#    web_server:
#      sorting_group_id: Control
#     sorting_weight: 10

#  - name: "Discharging Cutoff Capacity" # not working on V3 / V139 ?
#    id: discharging_cutoff_capacity
#    icon: mdi:battery-10
#    mode: box
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 44001
#    value_type: U_WORD
#    unit_of_measurement: "%"
#    min_value: 12
#    max_value: 30
#    multiply: 10
#    skip_updates: 6 # 30 seconds
#    web_server:
#     sorting_group_id: Control
#      sorting_weight: 11

  - name: "Max. Charge Power"
    id: max_charge_power
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 44002
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds
    web_server:
      sorting_group_id: Control
      sorting_weight: 7

  - name: "Max. Discharge Power"
    id: max_discharge_power
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 44003
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds
    web_server:
      sorting_group_id: Control
      sorting_weight: 8

###############################################################################
## STATUS LED
###############################################################################
## Simple status led for Atom s3 (lite)
## G35=RGB WS2812C-2020
light:
  - name: "Status led"
    id: status_led
    icon: mdi:lightbulb
    platform: esp32_rmt_led_strip
    internal: true # Hides from Home Assistant
    rgb_order: GRB
    pin: 35
    num_leds: 4
    chipset: ws2812
#    rmt_channel: 0 #only on platform: arduino
    restore_mode: ALWAYS_OFF
    entity_category: diagnostic
    effects:
      - pulse:
          name: slow_pulse
          transition_length: 250ms
          update_interval: 500ms
          min_brightness: 10%
          max_brightness: 50%
      - pulse:
          name: fast_pulse
          transition_length: 100ms
          update_interval: 100ms
          min_brightness: 25%
          max_brightness: 100%
    web_server:
      sorting_group_id: Diagnostic
      sorting_weight: 13

# ðŸŸ¢ Green on => wifi connected- api connected/ Green blinking => wifi connected - api disconnected
# ðŸŸ£ Purple => wifi disconnected
# ðŸ”µ Blue => AP mode

interval:
  - interval: 10s
    then:
      if:
        condition:
          wifi.connected:
        then:
          if:
            condition:
              api.connected:
            then:
              - light.turn_on:
                  id: status_led
                  brightness: 50%
                  red: 0
                  green: 100%
                  blue: 0
                  effect: None
            else:
              - light.turn_on:
                  id: status_led
                  brightness: 50%
                  red: 0
                  green: 100%
                  blue: 0
                  effect: slow_pulse              
        else:
          if:
            condition:
              - lambda: 'return id(id_captive_portal).is_active();'
            then:
              - light.turn_on:
                  id: status_led
                  brightness: 100%
                  red: 0
                  green: 0
                  blue: 100%
            else:
              - light.turn_on:
                  id: status_led
                  brightness: 100%
                  red: 100%
                  green: 0
                  blue: 0

## knop op de atom ingedrukt houden = veranderen brightness
script:
  - id: adjust_brightness_loop
    mode: restart
    then:
      - repeat:
          count: 1000
          then:
            - lambda: |-
                static float brightness = 0.0;
                brightness += 0.1;
                if (brightness > 1.0) brightness = 0.0;
                auto call = id(status_led).make_call();
                call.set_brightness(brightness);
                call.perform();
            - delay: 750ms
